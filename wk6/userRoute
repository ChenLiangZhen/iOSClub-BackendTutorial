const express = require("express");
const { MongoClient } = require("mongodb");

const uri = "mongodb://localhost:27017";
const client = new MongoClient(uri)

const userRoute = express.Router()

async function createUser(_userName, _userEmail, _phone) {

    return new Promise(async (resolve, reject) => {

        try {

            const database = client.db('users');
            const userAccount = database.collection('user_account');

            const user = {
                userName: _userName,
                userEmail: _userEmail,
                phone: _phone
            }

            await userAccount.insertOne(user);

            resolve("USER CREATED : " + JSON.stringify(user, "", 2))

        } catch (e) {

            reject("USER CREATION ERROR")

        }
    })
}

async function deleteUser(_userName) {
    return new Promise(async (resolve, reject) => {

        try {

            const database = client.db('users');
            const userAccount = database.collection('user_account');

            const user = {
                userName: _userName,
                userEmail: _userEmail,
                phone: _phone
            }

            await userAccount.deleteOne({ userName: _userName });

            resolve("USER DELETED : " + _userName)

        } catch (e) {

            reject("USER DELETION ERROR")

        }
    })
}

userRoute.get("/create-user",  (req, res, g ,gd, dd) => {

    const { userName, userEmail, phone } = req.body
   
    createUser(userName, userEmail, phone).then( 
      res => {
      res.status(200).send(success) 
   
    }, rej =>{
      res.status(500).send(failed) 
    })
})
  

userRoute.get("/delete-user/:targetUser",  (req, res) => {

    const { targetUser } = req.params 
  
    deleteUser(targetUser).then( 
        res => {
        res.status(200).send("SUCCESS") 

    }, rej =>{
        res.status(500).send("FAILED TO CREATE USER", failed)
    })
})

module.exports = userRoute